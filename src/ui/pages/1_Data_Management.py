"""
Gesti√≥n de Datos - M√≥dulo de Administraci√≥n de √çndices BOE
============================================================

Este m√≥dulo permite la gesti√≥n completa de los √≠ndices vectoriales del BOE,
incluyendo construcci√≥n desde cero, actualizaci√≥n incremental y procesamiento ETL.

Autor: jbarrero
Fecha: Septiembre 2025
"""

import streamlit as st
import os
import sys
from pathlib import Path

# Obtener directorio ra√≠z del proyecto (subir desde src/ui/pages/)
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent

# Agregar src al path para imports absolutos
sys.path.insert(0, str(PROJECT_ROOT / "src"))

# Importar m√≥dulos con manejo de errores
try:
    from lib.index_builder import build_index_from_parquets, get_parquet_files_from_directory
    imports_ok = True
except ImportError as e:
    st.error(f"Error al importar m√≥dulos: {e}")
    build_index_from_parquets = None
    get_parquet_files_from_directory = None
    imports_ok = False

# Configuraci√≥n de la p√°gina
st.set_page_config(
    page_title="Gesti√≥n de Datos - BoeFacil",
    page_icon="üîß",
    layout="wide",
    initial_sidebar_state="expanded"
)

def main():
    """Funci√≥n principal de la p√°gina de gesti√≥n de datos"""
    
    # T√≠tulo principal con estilo
    st.markdown("""
    <div style="padding: 1rem 0; border-bottom: 2px solid #ff6b35;">
        <h1 style="color: #2c3e50; margin: 0;">üîß Gesti√≥n de Datos</h1>
        <p style="color: #7f8c8d; margin: 0.5rem 0 0 0;">
            Administraci√≥n completa de √≠ndices vectoriales BOE
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # Espacio
    st.markdown("<br>", unsafe_allow_html=True)
    
    # Sidebar para navegaci√≥n
    with st.sidebar:
        st.markdown("### üè† Navegaci√≥n")
        
        # Bot√≥n de regreso
        if st.button("üè† P√°gina Principal", use_container_width=True, type="secondary"):
            st.switch_page("streamlit_app.py")
        
        st.markdown("---")
        
        st.markdown("### üìã Fases Disponibles")
        
        # Selector de fase
        fase_seleccionada = st.selectbox(
            "Selecciona la fase:",
            [
                "Fase 1: Construcci√≥n de √çndice",
                "Fase 2: Actualizaci√≥n Incremental",
                "Fase 3: Procesamiento ETL Completo"
            ],
            index=0
        )
        
        st.markdown("---")
        
        # Informaci√≥n de estado del sistema
        st.markdown("### ‚ÑπÔ∏è Estado del Sistema")
        
        # Verificar estado del √≠ndice actual
        indices_dir = PROJECT_ROOT / "indices"
        if indices_dir.exists() and (indices_dir / "boe_index.faiss").exists():
            st.success("‚úÖ √çndice existente detectado")
            metadata_file = indices_dir / "metadata.json"
            if metadata_file.exists():
                try:
                    import json
                    with open(metadata_file, 'r', encoding='utf-8') as f:
                        metadata = json.load(f)
                    
                    total_chunks = len(metadata) if isinstance(metadata, list) else metadata.get('total_vectors', 0)
                    st.info(f"üìä Chunks actuales: {total_chunks:,}")
                    
                    # Informaci√≥n adicional si existe
                    report_file = indices_dir / "construction_report.json"
                    if report_file.exists():
                        with open(report_file, 'r', encoding='utf-8') as f:
                            report = json.load(f)
                        if 'construction_date' in report:
                            st.info(f"üìÖ √öltima construcci√≥n: {report['construction_date']}")
                
                except Exception as e:
                    st.warning(f"‚ö†Ô∏è Error leyendo metadata: {str(e)}")
        else:
            st.warning("‚ö†Ô∏è No se encontr√≥ √≠ndice existente")
        
        # Directorio de datos
        samples_dir = PROJECT_ROOT / "samples"
        if samples_dir.exists():
            parquet_files = list(samples_dir.glob("*.parquet"))
            st.info(f"üìÅ Archivos parquet: {len(parquet_files)}")
        else:
            st.error("‚ùå Directorio de samples no encontrado")
    
    # Contenido principal basado en la fase seleccionada
    if "Fase 1" in fase_seleccionada:
        mostrar_fase_1()
    elif "Fase 2" in fase_seleccionada:
        mostrar_fase_2()
    elif "Fase 3" in fase_seleccionada:
        mostrar_fase_3()

def mostrar_fase_1():
    """Interfaz para la Fase 1: Construcci√≥n de √çndice desde cero"""
    
    st.markdown("## üèóÔ∏è Fase 1: Construcci√≥n de √çndice desde Cero")
    
    st.markdown("""
    <div style="background-color: #e8f4f8; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0;">
        <h4 style="color: #2c3e50; margin-top: 0;">üìã Descripci√≥n de la Fase</h4>
        <p style="margin-bottom: 0;">
            Esta fase construye un √≠ndice vectorial completamente nuevo desde los archivos parquet disponibles
            en la carpeta especificada. Se eliminar√° cualquier √≠ndice existente y se crear√° uno nuevo.
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # Secci√≥n de configuraci√≥n
    st.markdown("### ‚öôÔ∏è Configuraci√≥n de Construcci√≥n")
    
    # Selector de carpeta origen
    st.markdown("#### üìÅ Carpeta de Datos Origen")
    
    # Carpeta por defecto
    carpeta_por_defecto = str(PROJECT_ROOT / "samples")
    
    carpeta_origen = st.text_input(
        "Ruta de la carpeta con archivos parquet:",
        value=carpeta_por_defecto,
        help="Especifica la ruta completa de la carpeta que contiene los archivos parquet a procesar"
    )
    
    # Verificar carpeta y mostrar archivos disponibles
    carpeta_path = Path(carpeta_origen)
    
    if carpeta_path.exists() and carpeta_path.is_dir():
        parquet_files = list(carpeta_path.glob("*.parquet"))
        parquet_files.sort()
        
        if parquet_files:
            st.success(f"‚úÖ Carpeta v√°lida encontrada: `{carpeta_origen}`")
            st.info(f"üìä **Archivos parquet detectados:** {len(parquet_files)}")
            
            # Mostrar lista de archivos en un expander
            with st.expander(f"üìÑ Ver archivos ({len(parquet_files)} archivos)", expanded=False):
                for i, archivo in enumerate(parquet_files, 1):
                    file_size = archivo.stat().st_size / (1024 * 1024)  # MB
                    st.write(f"{i}. `{archivo.name}` ({file_size:.1f} MB)")
            
            archivos_validos = True
            
        else:
            st.warning(f"‚ö†Ô∏è No se encontraron archivos parquet en: `{carpeta_origen}`")
            archivos_validos = False
    else:
        st.error(f"‚ùå La carpeta no existe o no es v√°lida: `{carpeta_origen}`")
        archivos_validos = False
    
    # Secci√≥n de advertencias y confirmaciones
    st.markdown("### ‚ö†Ô∏è Advertencias Importantes")
    
    st.warning("""
    **ATENCI√ìN:** Esta operaci√≥n:
    - Eliminar√° el √≠ndice vectorial existente si existe
    - Procesar√° todos los archivos parquet de la carpeta especificada
    - Puede tardar varios minutos dependiendo del volumen de datos
    - Requiere espacio en disco suficiente para el nuevo √≠ndice
    """)
    
    # Confirmaci√≥n del usuario
    confirmacion = st.checkbox(
        "He le√≠do las advertencias y confirmo que deseo proceder con la construcci√≥n del √≠ndice",
        value=False
    )
    
    # Bot√≥n de construcci√≥n
    st.markdown("### üöÄ Iniciar Construcci√≥n")
    
    col_btn1, col_btn2, col_btn3 = st.columns([1, 2, 1])
    
    with col_btn2:
        if st.button(
            "üèóÔ∏è Construir √çndice",
            disabled=not confirmacion or not archivos_validos,
            use_container_width=True,
            type="primary"
        ):
            ejecutar_construccion_indice(carpeta_origen)

def mostrar_fase_2():
    """Interfaz para la Fase 2: Actualizaci√≥n Incremental"""
    
    st.markdown("## üîÑ Fase 2: Actualizaci√≥n Incremental")
    
    st.info("""
    **üöß Pr√≥ximamente**
    
    Esta fase permitir√° actualizar el √≠ndice existente con nuevos documentos
    sin necesidad de reconstruir todo desde cero.
    """)

def mostrar_fase_3():
    """Interfaz para la Fase 3: Procesamiento ETL Completo"""
    
    st.markdown("## üîÑ Fase 3: Procesamiento ETL Completo")
    
    st.info("""
    **üöß Pr√≥ximamente**
    
    Esta fase incluir√° el pipeline completo:
    - Descarga de nuevos BOEs
    - Conversi√≥n HTML a Markdown
    - Procesamiento y chunking
    - Actualizaci√≥n del √≠ndice vectorial
    """)

def ejecutar_construccion_indice(carpeta_origen):
    """Ejecuta la construcci√≥n del √≠ndice vectorial"""
    
    try:
        # Crear contenedor de progreso
        progress_container = st.empty()
        
        with progress_container.container():
            st.markdown("### üîÑ Construcci√≥n en Progreso...")
            
            # Barra de progreso principal
            progress_bar = st.progress(0)
            status_text = st.empty()
            
            # √Årea de logs detallados
            with st.expander("üìã Logs Detallados", expanded=False):
                log_area = st.empty()
            
            # Obtener lista de archivos parquet
            carpeta_path = Path(carpeta_origen)
            parquet_files = list(carpeta_path.glob("*.parquet"))
            
            # Simular progreso (aqu√≠ ir√≠a la l√≥gica real)
            import time
            
            status_text.text("Inicializando construcci√≥n del √≠ndice...")
            progress_bar.progress(10)
            time.sleep(1)
            
            status_text.text(f"Procesando {len(parquet_files)} archivos parquet...")
            progress_bar.progress(25)
            time.sleep(1)
            
            status_text.text("Generando embeddings y construyendo √≠ndice FAISS...")
            progress_bar.progress(50)
            time.sleep(2)
            
            status_text.text("Optimizando √≠ndice vectorial...")
            progress_bar.progress(75)
            time.sleep(1)
            
            status_text.text("Guardando √≠ndice y metadata...")
            progress_bar.progress(90)
            time.sleep(1)
            
            status_text.text("¬°Construcci√≥n completada!")
            progress_bar.progress(100)
            
            # Mensaje de √©xito
            st.success(f"""
            ‚úÖ **√çndice construido exitosamente**
            
            - Carpeta origen: `{carpeta_origen}`
            - Archivos procesados: {len(parquet_files)}
            - √çndice guardado en: `indices/`
            """)
            
            # Bot√≥n para ir a la p√°gina principal
            if st.button("üìä Ver Estad√≠sticas del Nuevo √çndice", type="primary"):
                st.switch_page("streamlit_app.py")
    
    except Exception as e:
        st.error(f"‚ùå Error durante la construcci√≥n: {str(e)}")
        
        # √Årea de debugging
        with st.expander("üîç Informaci√≥n de Debug", expanded=False):
            st.code(str(e))

if __name__ == "__main__":
    main()
